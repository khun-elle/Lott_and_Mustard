---
title: "Lott & Mustard Replication"
author: "Elle Boodsakorn"
date: "5/4/2022"
output:
  md_document:
    variant: markdown_github
always_allow_html: yes
---

```{r setup, include=FALSE, echo=FALSE}
load.libraries <- c('did', 'tidyverse', 'haven', 'fixest', 'skimr', 'kableExtra', 'stargazer', 'foreign', 'sjPlot', 'sjmisc', 'sjlabelled', 'bacondecomp', 'jpeg', 'png')
install.lib <- load.libraries[!load.libraries %in% installed.packages()]
for(libs in install.lib) install.packages(libs, dependences = TRUE)
sapply(load.libraries, require, character = TRUE)
```

## Lott and Mustard Replication

### 1. Introduction

Inspired by Crime, Deterrence, and Right-to-Carry Concealed Handguns by Lott and Mustard, I was incited to expand their findings and attempt to replicate their regression results using modern statistical techniques to reaffirm their conclusion that passing shall issue laws is essential to protect the fundamental right of self-defense for the U.S. citizens. 

In 1997, Lott and Mustard published their controversial paper revealing that right-to-carry concealed weapons laws are helpful in reducing crimes and at the same time cause no increase in accidental deaths. Their studies utilize cross-sectional time-series data for the U.S. between 1977 to 1992 to investigate the effect of permitting the right to use firearms on log crime rates. They found many types of crimes such as murder rate, rape rate, and aggravated assaults rate are reduced significantly for the counties that implement such laws. The sensational counterintuitive association between carrying a concealed handgun and the reduction in crimes are of interest to the public because it could promote the health and safety of our citizens. Lott and Mustard further claimed that these shall issue laws not only provide benefits to those who carry handguns, but also to those who don’t. Especially among women, even if a minute fraction of women own guns, “the external benefits to other women from a woman carrying a concealed handgun appear to be large relative to the gain produced by an additional man carrying a concealed handgun up to 3 to 4 times”$$^1$$. This is because the criminals face a heightened expected costs from committing crimes and the higher probability of getting caught. Although, the results could potentially lead to higher property crimes due to substitution effects, the overall net gain from the passage of shall issue laws is still positive.

Our analysis attempted to replicate the authors’ results using twoway fixed effects even though the outcomes are likely to be biased due to dynamic treatment effects. The issue of dynamic treatment effects calls for other estimators that do not have a no sign flip property such as Callaway & Sant’anna or Sun & Abraham. In addition, we implement bacon decomposition to examine the weights and the average DID estimate. 

The paper is organized as follows. In Sect. 2, we provide a background understanding of the original Lott and Mustard project and economic theories related to deterrence in crimes. Summary statistics of state-level data are presented in Sect. 3. Empirical model and estimation, twoway fixed effects model and Bacon decomposition are estimated in Sect. 4. In Sect. 5, we extend the original analysis by employing Callaway and Sant’Anna estimator and report overall ATTs with standard errors. Sun and Abraham event studies are carried out in Sect. 6. Finally, Sect. 7 concludes.

```{r setup 1.1, warning=FALSE, echo=FALSE}
StateLevelData <- read_dta("/Users/jirapat/Desktop/STATA/Causal/UpdatedStateLevelData-2010.dta") %>% filter(year >= 1977 & year <= 1992)

#rename variables
LM <- StateLevelData %>% select(fipsstat:year,
                                shalll,
                                Violent_Crime_Rate = ratvio,
                                Murder_Rate = ratmur,
                                Rape_Rate = ratrap,
                                Aggravate_Assult_Rate = rataga,
                                Robbery_Rate = ratrob,
                                Property_Crime_Rate = ratpro,
                                Auto_Theft_Rate = rataut,
                                Burglary_Rate = ratbur,
                                Larceny_Rate = ratlar,
                                Arrest_Rate_for_Violent_Crime = aovio,
                                Arrest_Rate_for_Murder = aomur,
                                Arrest_Rate_for_Rape = aorap,
                                Arrest_Rate_for_Robbery = aorob,
                                Arrest_Rate_for_Aggravated_Assault = aoaga,
                                Arrest_Rate_for_Property_Crimes = aopro,
                                Arrest_Rate_for_Burglary = aobur,
                                Arrest_Rate_for_Larceny = aolar,
                                Arrest_Rate_for_Auto_Theft = aoaut,
                                Arrest_Rate_for_Violent_Crimes = aovio,
                                RPC_Personal_Income = rpcpi,
                                RPC_Unemployment_Insurance = rpcui,
                                RPC_Income_Maintenance = rpcim,
                                RPC_retirement_pmt = rpcrpo,
                                everything()) %>% 
  mutate(across(Violent_Crime_Rate:Larceny_Rate, 
                .fns = list(log = ~log(.x)), 
                .names = "{.fn}.{.col}")) %>% 
  select(-c(starts_with("yr"), ends_with("rr"))) %>% as_tibble()
```

### 2 Background and Economic Theory 
#### 2.1 Related Literature
    
In their controversial paper, Lott and Mustard investigated the actual impacts of right-to-carry concealed-handgun laws on the deterrence of violent crime. They exploited a large data set of over 50,000 observations on nearly 200 variables. The variables include county level crime rates in their log forms, the corresponding arrest rates, demographic information, economic factors, and population characteristics. Then, they performed regressions using log crime rates as the dependent variables on shall-issue indicator variable, as well as arrest rates, and other controls. Although it is likely that their regressions suffer from specification error such as simultaneity bias in the estimation of arrest rate and crime rate, their results are found to be extremely robust. To enhance understandings, it is helpful to write out the model they estimate:
\
&nbsp;
  $$
  C_{i,t} = \alpha + \gamma I_{i,t} + \beta A_{i,t} + \delta X_{i,t} + \varepsilon_{i,t}
  $$
\
&nbsp;
Where $$I_{i,t}$$ is the shall-issue indicator variable, $$A_{i,t}$$ represents arrest rates, and $$X_{i,t}$$ denotes demographic information, economic factors, and population characteristics. It is clear from the regression specification that the effect of passing a shall-issue gun law is captured by the parameter $$\gamma$$. Positive value of $$\gamma$$ implies that shall-issue provisions are associated with higher crime rates, while negative value would suggest otherwise. This representation also implies that every county possesses the same slope but different intercepts depending on whether the law is adopted. The indicator variable $$I_{i,t}$$ took the unit value if county i adopt the law in year t and zero otherwise. From the data set, we observe that there are a total of 18 states that have ever adopted the laws at some point. 

#### 2.2 the deterrence effect of concealed carry weapon (shall issue) laws

The idea of shall-issue laws is that “In those states that have ‘shall-issue’ laws, concealed weapons permits are granted unless there is a good reason to deny them. In the remaining states, concealed weapons permits are issued only if the applicant can show that he or she needs to carry such a weapon”$$^2$$. The corollary is that potential criminals are deterred from committing crimes since there is a significantly greater chance of running into an armed citizen. From this perspective, we can employ Becker’s model (1968) to help explicate the decision making process of an offender$$^3$$. Simply put, a risk-neutral offender solves his utility maximization problem weighing costs and benefits of committing a crime. The offender commits crime if and only if the expected payoffs are positive, otherwise, he abstains from it. The cost can be raised by allowing citizens to carry concealed guns or increasing the probability of being arrested. When the offender believes that the probability of confronting an armed person is high, he substitutes toward “property crimes involving stealth and where the probability of contact between the criminal and the victim are minimal” to avoid getting injured$$^1$$. The second reasoning behind deterrence theory is that “victims who have guns are in a much better position to defend themselves”$$^10$$. Another strategy to reduce violent crime is increasing spending on police, however, it is incontrovertible that simply allowing citizens to defend themselves is more economical$$^2$$.

To sum up, the authors found that shall-issue laws are significantly associated with lower violent crime. They asserted that if the laws were adopted nationwide in 1992, it would have been possible to avoid at least 1,570 murders and 4,177 rapes. Although the rate of property crime might increase due to substitution effects, the net effect of allowing handguns remains positive and is socially beneficial. The robust results allow us to draw confident conclusions about the impact of right‐to‐carry laws on violent crime.

<div align="center">
```{r setup 1.2, warning=FALSE, echo=FALSE}
#rollout
rollout <- LM %>% 
  select(state:shalll) %>% 
  mutate(yearXshalll = year * shalll) %>% 
  group_by(state) 

rollout <- rollout[rollout$shalll != 0, ] 
rollout <- rollout[match(unique(rollout$state), rollout$state),]  %>% 
  select(state, yearXshalll) %>% 
  rename(year_first_treated = yearXshalll) %>% 
  as_tibble() %>% 
  arrange(year_first_treated)

kbl(rollout, col.names = c("State", "Year First Treated"), caption = "**Table 1: A Table of Rollout State By State", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```
</div>

<div align="center">
```{r setup 1.3, warning=FALSE, echo=FALSE}
#table 1
stats <- list(
  mean = ~mean(.x, na.rm = TRUE),
  standard_deviation = ~sd(.x, na.rm = TRUE)
)

t1 <- LM %>% select(state, Violent_Crime_Rate:Arrest_Rate_for_Violent_Crimes) %>%
  group_by(state) %>% 
  summarise(across(c(Violent_Crime_Rate:Arrest_Rate_for_Violent_Crimes), 
                   stats), .names = "{.fn}.{.col}") %>%
  ungroup() %>% 
  tibble::as_tibble() %>% 
  summarise(across(ends_with("_mean"), 
                   ~ sd(.x, na.rm = TRUE), .names = "standard_deviation_of_{.col}"),
            across(ends_with("_standard_deviation"),
                   ~ mean(.x, na.rm = TRUE), .names = "mean_of_{.col}"))%>% t()%>% 
  round(2) %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  rename(variable = rowname, value = V1) %>%
  separate(col = variable, into = c("Stats", "Variables"), sep = "_of_") %>% 
  
  pivot_wider(names_from = Stats, values_from = value, values_fill = 0) %>%
  rename(c(Std_of_State_Mean = standard_deviation, Mean_of_State_Std = mean)) 

#shift the values of the last column up
shift <- function(x, n){
  c(x[-(seq(n))], rep(NA, n))
}

t1$Mean_of_State_Std <- shift(t1$Mean_of_State_Std, 19)
t1 <- t1[1:19, ]
t1$Variables=gsub("_mean", "", t1$Variables)

t1 %>% 
  mutate(Variables = str_replace_all(Variables, "_", " ")) %>%
  kbl(caption = "Table 1",
      col.names = c("Variable",
                    "Standard Deviation of State Means",
                    "Mean of Within-State Standard Deviations"),
      booktabs = T
  ) %>% 
  kable_styling(latex_options = c("striped", "HOLD_position"))
```
</div>

### 3. Data

The original data set from Lott and Mustard (1997) contains county-level data from 1982 to 1992. The variables include nine types of crime rates: violent crime rate, murder rate, rape rate, aggravated assault rate, robbery rate, property crime rate, auto theft rate, burglary rate, and larceny rate. The corresponding arrest rates for each type of crime are also provided to help with analyses. Other demographics, economics, and population characteristics are also supplied.

We use a subset of data examining only those years between 1977 to 1992. While the authors used county-level data, we choose to work with state-level data since the laws are ultimately at the state level. As suggested by Ayres and Donohue III (2002), using county data is likely to “exaggerate the amount of independent data available to the researcher, thereby possibly creating the appearance of statistical significance when in fact none exists”$$^4$$. In addition, Lott and Mustard used arrest rates which resulted in many counties with missing data being dropped which likely led to biases. Using state-level data can improve accuracy and precision of our regression analysis.

Table 2 presents a summary of violent crimes and their corresponding arrest rates showing number of observations, mean, and standard deviation. The summary statistics are also reported for economics, and demographic variables.

<div align="center">
```{r setup 1.4, warning=FALSE, echo=FALSE}
#table 2
stats_2 <- list(
  Obs = length,
  mean = ~mean(.x, na.rm = TRUE),
  standard_deviation = ~sd(.x, na.rm = TRUE)
)

t2 <- LM %>% select(shalll:RPC_retirement_pmt) %>% 
  summarise(across(c(shalll:RPC_retirement_pmt), 
                   stats_2, .names = "{.fn}.{.col}")) %>% 
  tibble::as_tibble() %>% 
  t()%>% 
  round(5) %>% 
  as.data.frame() %>% 
  rownames_to_column() %>%  
  rename(variable = rowname, value = V1) %>%
  separate(col = variable, into = c("Stats", "Variables"), sep = "\\.") %>% 
  pivot_wider(names_from = Variables, values_from = value, values_fill = 0) %>% 
  t() %>%
  as.data.frame() %>% 
  rownames_to_column() %>% 
  janitor::row_to_names(row_number = 1)

t2$Obs <- as.integer(t2$Obs)
t2$mean <- as.numeric(t2$mean)
t2$standard_deviation <- as.numeric(t2$standard_deviation)

t2 <- t2 %>% mutate(Stats = str_replace_all(Stats, "_", " "),
                    Stats = str_to_title(Stats))

row.names(t2) <- NULL

t2 %>% 
  kbl(caption = "Table 2: Summary Statistics for Various Crime Outcomes and Demographics Variables",
      col.names = c("Variable",
                    "Obs",
                    "Mean",
                    "Std Dev."),
      booktabs = T
  ) %>% 
  kable_styling(latex_options = c("striped", "HOLD_position"))
```
</div>

<div align="center">
```{r setup 1.5, warning=FALSE, echo=FALSE}
#table 2 cont.
LM %>% select(shalll, starts_with("Arrest_Rate_"), Violent_Crime_Rate:Larceny_Rate, starts_with("RPC_"), starts_with("pp")) %>% 
  summarise(across(everything(), 
                   stats_2, .names = "{.fn}.{.col}")) %>% 
  tibble::as_tibble() %>% 
  t()%>% 
  round(5) %>% 
  as.data.frame() %>% 
  rownames_to_column() %>%  
  rename(variable = rowname, value = V1) %>% 
  separate(col = variable, into = c("Stats", "Variables"), sep = "\\.") %>% 
  pivot_wider(names_from = Stats, values_from = value, values_fill = 0) %>%
  as.data.frame() %>% 
  slice(25:67) %>%
  mutate(Variables = recode(Variables, 
                            ppwm1019 = 'White Male Between 10-19',
                            ppbm1019 = 'Black Male Between 10-19',
                            ppnm1019 = 'Other Male Between 10-19',
                            ppwf1019 = 'White Female Between 10-19',
                            ppbf1019 = 'Black Female Between 10-19',
                            ppnf1019 = 'Other Female Between 10-19',
                            ppwm2029 = 'White Male Between 20-29',
                            ppbm2029 = 'Black Male Between 20-29',
                            ppnm2029 = 'Other Male Between 20-29',
                            ppwf2029 = 'White Female Between 20-29',
                            ppbf2029 = 'Black Female Between 20-29',
                            ppnf2029 = 'Other Female Between 20-29',
                            ppwm3039 = 'White Male Between 30-39',
                            ppbm3039 = 'Black Male Between 30-39',
                            ppnm3039 = 'Other Male Between 30-39',
                            ppwf3039 = 'White Female Between 30-39',
                            ppbf3039 = 'Black Female Between 30-39',
                            ppnf3039 = 'Other Female Between 30-39',
                            ppwm4049 = 'White Male Between 40-49',
                            ppbm4049 = 'Black Male Between 40-49',
                            ppnm4049 = 'Other Male Between 40-49',
                            ppwf4049 = 'White Female Between 40-49',
                            ppbf4049 = 'Black Female Between 40-49',
                            ppnf4049 = 'Other Female Between 40-49',
                            ppwm5064 = 'White Male Between 50-64',
                            ppbm5064 = 'Black Male Between 50-64',
                            ppnm5064 = 'Other Male Between 50-64',
                            ppwf5064 = 'White Female Between 50-64',
                            ppbf5064 = 'Black Female Between 50-64',
                            ppnf5064 = 'Other Female Between 50-64',
                            ppwm65o = 'White Male Over 65',
                            ppbm65o = 'Black Male Over 65',
                            ppnm65o = 'Other Male Over 65',
                            ppwf65o = 'White Female Over 65',
                            ppbf65o = 'Black Female Over 65',
                            ppnf65o = 'Other Female Over 65')) %>% 
  slice(-(1:7)) %>% 
  kbl(caption = "Table 2 Cont.",
      col.names = c("Variable",
                    "Obs",
                    "Mean",
                    "Std Dev."),
      booktabs = T
  ) %>% 
  kable_styling(latex_options = c("striped", "HOLD_position"))

```
</div>

### 4. Empirical model and Estimation 
#### 4.1 Twoway Fixed Effects

We reexamine the twoway fixed effects regression (TWFE) similarly to the one used by the authors, only we will be using the state-level data instead of county-level data. It is critical to note that TWFE estimates will be biased if average treatment effect changes over time or parallel trend assumption fails to hold. We proceed with the nine regressions where the outcome is each type of crime rates in logarithmic form. Other variables such as shall issue dummy, arrest rates, economics, and demographic information are used as controls. The following table presents the results.

```{r setup 1.6, warning=FALSE, echo=FALSE, message=FALSE}
#table 3
ln_crime_rate <- LM %>% select(starts_with("log."))

fe <- LM %>% select(state, year)

shall <- LM %>% select(shalll)

arrest_rates <- LM %>% select(Arrest_Rate_for_Violent_Crime:Arrest_Rate_for_Auto_Theft)

independent_variables <- LM %>% select(starts_with("RPC_"), ppwm1019:ppnf65o, density, popstate)

regression <- list()

for (i in 1:9) {
  df <- cbind(ln_crime_rate[,i], shall, arrest_rates[,i], independent_variables, fe)
  
  dependent_variable <- colnames(df)[1]
  colnames(df)[3] <- "Its_corresponding_Arrest_Rate"
  X <- colnames(df)[2:45] %>% 
    paste(.,collapse = " + ")
  two_ways_fixed_effect <- colnames(df)[46:47] %>% 
    paste(., collapse = " + ")
  
  formula <- as.formula(paste(dependent_variable, " ~ ", X, " | ", two_ways_fixed_effect, sep=""))
  
  mdl <- feols(fml = formula, data = df, vcov = "HC1")
  
  regression[[dependent_variable]] <- mdl
}
```

<div align="center">
```{r setup 1.7, warning=FALSE, echo=FALSE}
tab_model(regression[1:3], 
          show.ci = FALSE, 
          show.se = TRUE, 
          show.p = FALSE,
          show.intercept = TRUE,
          digits = 5,
          dv.labels = c("Log Violent Crime Rate", "Log Murder Rate", "Log Rape Rate"))

tab_model(regression[4:6], 
          show.ci = FALSE, 
          show.se = TRUE, 
          show.p = FALSE, 
          show.intercept = TRUE,
          digits = 5,
          dv.labels = c("Log Aggravate Assult Rate", "Log Robbery Rate", "Log Property Crime Rate"))

tab_model(regression[7:9], 
          show.ci = FALSE, 
          show.se = TRUE, 
          show.p = FALSE, 
          show.intercept = TRUE,
          digits = 5,
          dv.labels = c("Log Auto Theft Rate", "Log Burglary Rate", "Log Larceny Rate"))
```
</div>

Examination of the regression results shows the effect of concealed-handgun laws on various categories of crime. Specifically, we observe a negative relationship between passage of the laws and all types of crime except for larceny, suggesting that adopting shall-issue statutes can significantly reduce crime rates. However, the caveat of this regression specification is that by using a single indicator variable for the laws, we are explicitly assuming the same effect across all states and years. This issue has been investigated further by Black and Nagin (1998). They generated state-specific dummy variables for the shall-issue laws and found that the signs of the coefficients vary across states, with some positive and some negative$$^5$$. So the effects are unclear and thus, we will explore other models in Section 4 before drawing any conclusions about the laws.

#### 4.2 Bacon Decomposition

The tables below present Bacon decomposition of twoway fixed effects estimate. Goodman-Bacon (2019) shows that the estimate is a weighted average of 2x2 parameters and their weights as determined by their relative size in the data. Under restrictive assumptions of parallel trends and time invariant treatment effects, the estimate reflects the actual ATT. In our analysis of the effect of shall-issue laws on crime rates, states opted for the laws at different points in time, so we can expect twoway fixed effects models to be biased. 

It is important to note that twoway fixed effects do not weight all 2x2s uniformly. It places higher weight to states that were treated in the middle of the panel, since these states have maximum treatment variance. In our data, about 75 percent of the weights are assigned to treated versus untreated units. So this 2x2 contributes the most to the resulting twoway fixed effects estimate followed by later versus always treated, and earlier versus later respectively. The only problematic comparison is when you compare the later group to the already-treated earlier group since the estimate also contains parallel trends bias and heterogeneity in time bias. Unless the parallel trends assumption is satisfied and the treatment effects are constant for a group over time, we suffer severely from bias$$^6$$.

<div align="center">
```{r setup 1.8, warning=FALSE, echo=FALSE}
#Bacon Decomposition without controls
data_for_bacon <- LM %>% select(state:shalll, starts_with("log."))

#when y = log.Violent_Crime_Rate
df_bacon1 <- bacon(log.Violent_Crime_Rate ~ shalll,
                  data = data_for_bacon,
                  id_var = "state",
                  time_var = "year",
                  quietly = TRUE) %>%   
  mutate(weighted_estimate = estimate * weight) %>% 
  group_by(type) %>%
  summarise(weights = sum(weight),
            average_DID_estimate = mean(estimate),
            weighted_estimate = sum(weighted_estimate))
            

kbl(df_bacon1, col.names = c("Type", "Weights", "Average DID Estimate", "Weighted Estimate"), caption = "**Bacon Decomposition: Log Violent Crime Rate**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

coef_bacon1 <- sum(df_bacon1$weighted_estimate)

print(paste("Weighted sum of decomposition =", round(coef_bacon1, 4)))

fit_tw1 <- lm(log.Violent_Crime_Rate ~ shalll + factor(state) + factor(year),
             data = data_for_bacon)

print(paste("Two-way FE estimate =", round(fit_tw1$coefficients[2], 4)))
```
</div>

<div align="center">
```{r setup 1.9, warning=FALSE, echo=FALSE}
#when y = log.Murder_Rate
df_bacon2 <- bacon(log.Murder_Rate ~ shalll,
                   data = data_for_bacon,
                   id_var = "state",
                   time_var = "year",
                   quietly = TRUE) %>% 
  mutate(weighted_estimate = estimate * weight) %>% 
  group_by(type) %>%
  summarise(weights = sum(weight),
            average_DID_estimate = mean(estimate),
            weighted_estimate = sum(weighted_estimate))

kbl(df_bacon2, col.names = c("Type", "Weights", "Average DID Estimate", "Weighted Estimate"), caption = "**Bacon Decomposition: Log Murder Rate**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

coef_bacon2 <- sum(df_bacon2$weighted_estimate)

print(paste("Weighted sum of decomposition =", round(coef_bacon2, 4)))

fit_tw2 <- lm(log.Murder_Rate ~ shalll + factor(state) + factor(year), 
              data = data_for_bacon)

print(paste("Two-way FE estimate =", round(fit_tw2$coefficients[2], 4)))
```
</div>

<div align="center">
```{r setup 1.10, warning=FALSE, echo=FALSE}
#when y = log.Rape_Rate
df_bacon3 <- bacon(log.Rape_Rate ~ shalll,
                   data = data_for_bacon,
                   id_var = "state",
                   time_var = "year",
                   quietly = TRUE) %>% 
  mutate(weighted_estimate = estimate * weight) %>% 
  group_by(type) %>%
  summarise(weights = sum(weight),
            average_DID_estimate = mean(estimate),
            weighted_estimate = sum(weighted_estimate))

kbl(df_bacon3, col.names = c("Type", "Weights", "Average DID Estimate", "Weighted Estimate"), caption = "**Bacon Decomposition: Log Rape Rate**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

coef_bacon3 <- sum(df_bacon3$weighted_estimate)

print(paste("Weighted sum of decomposition =", round(coef_bacon3, 4)))

fit_tw3 <- lm(log.Rape_Rate ~ shalll + factor(state) + factor(year), 
              data = data_for_bacon)

print(paste("Two-way FE estimate =", round(fit_tw3$coefficients[2], 4)))
```
</div>

<div align="center">
```{r setup 1.11, warning=FALSE, echo=FALSE}
#when y = log.Aggravate_Assult_Rate
df_bacon4 <- bacon(log.Aggravate_Assult_Rate ~ shalll,
                   data = data_for_bacon,
                   id_var = "state",
                   time_var = "year",
                   quietly = TRUE) %>% 
  mutate(weighted_estimate = estimate * weight) %>% 
  group_by(type) %>%
  summarise(weights = sum(weight),
            average_DID_estimate = mean(estimate),
            weighted_estimate = sum(weighted_estimate))

kbl(df_bacon4, col.names = c("Type", "Weights", "Average DID Estimate", "Weighted Estimate"), caption = "**Bacon Decomposition: Log Aggravate Assault Rate**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

coef_bacon4 <- sum(df_bacon4$weighted_estimate)

print(paste("Weighted sum of decomposition =", round(coef_bacon4, 4)))

fit_tw4 <- lm(log.Aggravate_Assult_Rate ~ shalll + factor(state) + factor(year), 
              data = data_for_bacon)

print(paste("Two-way FE estimate =", round(fit_tw4$coefficients[2], 4)))
```
</div>

<div align="center">
```{r setup 1.12, warning=FALSE, echo=FALSE}
#when y = log.Robbery_Rate
df_bacon5 <- bacon(log.Robbery_Rate ~ shalll,
                   data = data_for_bacon,
                   id_var = "state",
                   time_var = "year",
                   quietly = TRUE) %>% 
  mutate(weighted_estimate = estimate * weight) %>% 
  group_by(type) %>%
  summarise(weights = sum(weight),
            average_DID_estimate = mean(estimate),
            weighted_estimate = sum(weighted_estimate))

kbl(df_bacon5, col.names = c("Type", "Weights", "Average DID Estimate", "Weighted Estimate"), caption = "**Bacon Decomposition: Log Robbery Rate**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

coef_bacon5 <- sum(df_bacon5$weighted_estimate)

print(paste("Weighted sum of decomposition =", round(coef_bacon5, 4)))

fit_tw5 <- lm(log.Robbery_Rate ~ shalll + factor(state) + factor(year), 
              data = data_for_bacon)

print(paste("Two-way FE estimate =", round(fit_tw5$coefficients[2], 4)))
```
</div>

<div align="center">
```{r setup 1.13, warning=FALSE, echo=FALSE}
#when y = log.Property_Crime_Rate
df_bacon6 <- bacon(log.Property_Crime_Rate ~ shalll,
                   data = data_for_bacon,
                   id_var = "state",
                   time_var = "year",
                   quietly = TRUE) %>% 
  mutate(weighted_estimate = estimate * weight) %>% 
  group_by(type) %>%
  summarise(weights = sum(weight),
            average_DID_estimate = mean(estimate),
            weighted_estimate = sum(weighted_estimate))

kbl(df_bacon6, col.names = c("Type", "Weights", "Average DID Estimate", "Weighted Estimate"), caption = "**Bacon Decomposition: Log Property Crime Rate**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

coef_bacon6 <- sum(df_bacon6$weighted_estimate)

print(paste("Weighted sum of decomposition =", round(coef_bacon6, 4)))

fit_tw6 <- lm(log.Property_Crime_Rate ~ shalll + factor(state) + factor(year), 
              data = data_for_bacon)

print(paste("Two-way FE estimate =", round(fit_tw6$coefficients[2], 4)))
```
</div>

<div align="center">
```{r setup 1.14, warning=FALSE, echo=FALSE}
#when y = log.Auto_Theft_Rate
df_bacon7 <- bacon(log.Auto_Theft_Rate ~ shalll,
                   data = data_for_bacon,
                   id_var = "state",
                   time_var = "year",
                   quietly = TRUE) %>% 
  mutate(weighted_estimate = estimate * weight) %>% 
  group_by(type) %>%
  summarise(weights = sum(weight),
            average_DID_estimate = mean(estimate),
            weighted_estimate = sum(weighted_estimate)) 

kbl(df_bacon7, col.names = c("Type", "Weights", "Average DID Estimate", "Weighted Estimate"), caption = "**Bacon Decomposition: Log Auto Theft Rate**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

coef_bacon7 <- sum(df_bacon7$weighted_estimate)

print(paste("Weighted sum of decomposition =", round(coef_bacon7, 4)))

fit_tw7 <- lm(log.Auto_Theft_Rate ~ shalll + factor(state) + factor(year), 
              data = data_for_bacon)

print(paste("Two-way FE estimate =", round(fit_tw7$coefficients[2], 4)))
```
</div>

<div align="center">
```{r setup 1.15, warning=FALSE, echo=FALSE}
#when y = log.Burglary_Rate
df_bacon8 <- bacon(log.Burglary_Rate ~ shalll,
                   data = data_for_bacon,
                   id_var = "state",
                   time_var = "year",
                   quietly = TRUE) %>% 
  mutate(weighted_estimate = estimate * weight) %>% 
  group_by(type) %>%
  summarise(weights = sum(weight),
            average_DID_estimate = mean(estimate),
            weighted_estimate = sum(weighted_estimate)) 

kbl(df_bacon8, col.names = c("Type", "Weights", "Average DID Estimate", "Weighted Estimate"), caption = "**Bacon Decomposition: Log Burglary Rate**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

coef_bacon8 <- sum(df_bacon8$weighted_estimate)

print(paste("Weighted sum of decomposition =", round(coef_bacon8, 4)))

fit_tw8 <- lm(log.Burglary_Rate ~ shalll + factor(state) + factor(year), 
              data = data_for_bacon)

print(paste("Two-way FE estimate =", round(fit_tw8$coefficients[2], 4)))
```
</div>

<div align="center">
```{r setup 1.16, warning=FALSE, echo=FALSE}
#when y = log.Larceny_Rate
df_bacon9 <- bacon(log.Larceny_Rate ~ shalll,
                   data = data_for_bacon,
                   id_var = "state",
                   time_var = "year",
                   quietly = TRUE) %>% 
  mutate(weighted_estimate = estimate * weight) %>% 
  group_by(type) %>%
  summarise(weights = sum(weight),
            average_DID_estimate = mean(estimate),
            weighted_estimate = sum(weighted_estimate))

kbl(df_bacon1, col.names = c("Type", "Weights", "Average DID Estimate", "Weighted Estimate"), caption = "**Bacon Decomposition: Log Larceny Rate**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

coef_bacon9 <- sum(df_bacon9$weighted_estimate)

print(paste("Weighted sum of decomposition =", round(coef_bacon9, 4)))

fit_tw9 <- lm(log.Larceny_Rate ~ shalll + factor(state) + factor(year), 
              data = data_for_bacon)

print(paste("Two-way FE estimate =", round(fit_tw9$coefficients[2], 4)))
```
</div>

### 5. Callaway and Sant'Anna

Since dynamic treatment effects can bias twoway fixed effect estimator by causing sign flip, we turn to Callaway and Sant’Anna (2020) estimator to help fix the issues that arise when using TWFE. Callaway and Sant’Anna deal with staggered treatment timing by considering each group separately by when they were treated. The estimator of interest is “group-time treatment effects” which can be calculated by “comparing the post-treatment outcomes of the groups treated in that period against the never-treated groups that are most similar to those treated groups”$$^7$$. The major difference between TWFE and Callaway and Sant’Anna estimator is that the latter doesn’t use already-treated as controls.
  
After we estimate group-time average treatment effects for each group across all time periods, we can then aggregate them into an overall treatment effect parameter. Therefore, the resulting estimate is the average effect of the treatment, or the shall-issue laws, experienced by all states that ever adopted the laws. The following table reports overall ATTs and standard errors for the model that uses each of the nine crime rates as a dependent variable, including year and state identification, and corresponding arrest rates as controls. We choose to present the overall treatment effect rather than group-level effects because many states simply do not have enough states per treatment date for the bootstrapping to provide accurate 95 percent confidence intervals. 

By comparing the results below to those estimated by using TWFE in Section 3, we notice the discrepancies between them in the coefficients and signs. In particular, the coefficients of property crime rate, rape rate, robbery rate, and auto theft rate switched signs. Callaway and Sant’Anna pointed out in their paper a special case of the only time where the overall effect parameters estimated using TWFE and their method exactly match is when the group-time treatment effect is the same across all states and years$$^8$$.


```{r setup 1.17, warning=FALSE, echo=FALSE, message=FALSE}
#Callaway & Sant'anna, Sun & Abraham
cs_data <- LM %>% select(fipsstat:shalll,
                         starts_with("log."),
                         starts_with("Arrest_Rate_")) %>% 
  group_by(fipsstat) %>% 
  mutate(treated = ifelse(sum(shalll) > 0, 1, 0)) %>% 
  ungroup() 

year_treated_for_each_state <- cs_data %>% 
  select(fipsstat:shalll) %>% 
  mutate(is_treated = year * shalll) %>% 
  group_by(fipsstat, shalll) %>% 
  summarise(year_treated = min(is_treated)) %>% 
  ungroup() 

year_treated_for_each_state <- year_treated_for_each_state[year_treated_for_each_state$shalll != 0, ] 

cs_data <- merge(x = cs_data, y = year_treated_for_each_state, by = "fipsstat", all.x = TRUE)

cs_data[is.na(cs_data)] = 0

cs_data <- cs_data[ , -which(names(cs_data) %in% c("state.y", "year.y", "shalll.y", "shalll.x", "treated", "shalll.x.1", "year_treated.y", "year_treated.x"))]

cs_data <- cs_data %>% select(fipsstat:year,
                              year_treated,
                              starts_with("log."),
                              Arrest_Rate_for_Violent_Crime,
                              Arrest_Rate_for_Murder,
                              Arrest_Rate_for_Rape,
                              Arrest_Rate_for_Aggravated_Assault,
                              Arrest_Rate_for_Robbery,
                              Arrest_Rate_for_Property_Crimes,
                              Arrest_Rate_for_Auto_Theft,
                              Arrest_Rate_for_Burglary,
                              Arrest_Rate_for_Larceny)

# objects <- c("cs_type_group", "cs_type_dynamic", "sa")
# 
# objectlist <- setNames(vector(length(objects), mode="list"), objects)

l1 <- c()
l2 <- c()
l3 <- c()

dependent_vars <- cs_data %>% select(starts_with("log.")) %>% names()
independent_vars <- cs_data %>% select(starts_with("Arrest_Rate_")) %>% names()
```

<div align="center">
```{r setup 1.18, warning=FALSE, echo=FALSE, message=FALSE}
for (n in 1:9){
  y <- dependent_vars[n]
  x <- independent_vars[n]
  rhs <- as.formula(paste('~', x))
  atts <- att_gt(yname = y, # LHS variable
                 tname = 'year', # panel time variable
                 idname = 'fipsstat', # firms' panel id variable
                 gname = 'year_treated', 
                 data = cs_data, # data
                 xformla = rhs,
                 est_method = "dr",
                 control_group = "notyettreated",
                 bstrap = TRUE, # if TRUE compute bootstrapped SE
                 biters = 1000, # number of bootstrap iterations
                 print_details = FALSE, # if TRUE, print detailed results
                 clustervars = 'fipsstat', # cluster level
                 panel = TRUE)
  agg_effects <- aggte(atts, type = "group", balance_e = TRUE, na.rm = TRUE)
  # summary(agg_effects)
  # l1 <- c(l1, agg_effects)
  # l2 <- c(l2, c(agg_effects$overall.att, agg_effects$overall.se))
  l1[[y]] <- agg_effects
  l2[[y]] <- c(agg_effects$overall.att, agg_effects$overall.se)
  
  sun_abbraham <- paste(y, '~', x, " + sunab(year_treated, year) | fipsstat + year") %>%
    as.formula()
  sun_abbraham_reg <- feols(fml = sun_abbraham, data = cs_data)
  # l3 <- c(l3, sun_abbraham_reg)
  l3[[y]] <- sun_abbraham_reg
}

l2 <- l2 %>% as.data.frame() %>%t() 

# l2_estimates <- l2[seq(1, nrow(l2), 2), ] %>% as.data.frame()
# l2_se <- l2[seq(2, nrow(l2), 2), ] %>% as.data.frame()
# types_of_crimes <- dependent_vars %>% as.data.frame()
# cs_table <- cbind(types_of_crimes, l2_estimates, l2_se)

kable(l2, col.names = c("Overall ATTs", "Overall SEs"), caption = "**Table 4 Callaway and Sant’anna Overall ATTs and Standard Errors**", format_caption = c("italic", "underline")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```
</div>

### 6. Sun and Abraham

```{r setup 1.19, warning=FALSE, echo=FALSE}
# Sun and Abraham event study
for (i in 1:9) {
  y <- dependent_vars[i]
  file_name <- paste0("/Users/jirapat/Desktop/R/Lott_and_Mustard/figures/", y, ".jpeg")
  jpeg(filename = file_name, width = 700, height = 350)
  iplot(l3[[y]], ref.line = -1, main = "")
  dev.off()
}
```
Similar to the approach in the previous section, Sun and Abraham’s estimator is a blend of Callaway and Sant’Anna and Goodman-Bacon. While many researchers tend to use twoway fixed effects regressions that include leads and lags of the treatment, they show that in the settings with staggered treatment adoption, the coefficient on a given lead or lag can be contaminated by effects from other periods$$^9$$. To remedy such issues, they invented an estimator that is free of contamination and is robust to treatment effects heterogeneity. Simply put, they first estimate each cohort average treatment effects on the treated (CATT) using a twoway fixed effects specification that interacts relative period indicators with cohort indicators, excluding indicators for never-treated cohorts. Then they estimate the weight, and average all CATTs to provide the average treatment effect. This estimator is called an “interaction-weighted” estimator; it uses sample shares of each cohort in the relevant periods to estimate the weights$$^9$$. 

The model being estimated here is similar to that in the previous section. We use each crime rate in its logarithmic form as dependent variable with its corresponding arrest rate as independent variable. State and year fixed effects are also added as usual. Then, we present the event studies figures that help validate the existence of pretrends visually. Take the following results for rape rates and murder rates.

<div align="center">
```{r setup 1.20, warning=FALSE, echo=FALSE}
img <- readPNG('log.Rape_Rate.png')
grid::grid.raster(img)
```
</div>

We observe no apparent pre-event trend prior to treatment year. In fact, all point estimates and their corresponding confidence intervals include zero for all 14 years prior to treatment year, reassuring that pre-event effects are effectively zero. Event studies graphs offer a functional way to evaluate cohort average treatment effects because they predict trends that are expected to see in the absence of treatment and how the realized outcome deviates from that prediction. On the right hand side of the graph, we notice statistically significant negative effects of shall-issue laws on rape rates. The laws delivered efficacious results for up to 4 years after they were passed. After that, it is unfortunate to see that the effects have been fading out over time. Rape rates took off again five years after the treatment year after which it becomes difficult to conclude any effect of the laws in the following years.

Event study estimation of murder rates exhibits a similar result. The graph does not suggest a violation of pretend assumptions. The point estimates and their 95 percent confidence intervals contain zero for up to 13 years prior to the treatment year. In addition, what is special for this particular analysis is that the confidence intervals are very narrow, indicating that the effect size is known precisely. After the treatment year, there are some evidence of a decline in murder rates. However, just like rape rates, the effects faded out over time.

<div align="center">
```{r setup 1.21, warning=FALSE, echo=FALSE}
img2 <- readPNG('log.Murder_Rate.png')
grid::grid.raster(img2)
```
</div>

### 7. Conclusion
#### 7.1 Summary and Conclusions
    
The publication of Lott and Mustard’s sensational findings of the negative association between citizen gun ownership and criminal deterrence has been of interest to legislators and policymakers. The authors utilized twoway fixed effects regressions to conclude that relatively easy access to handguns increases expected cost of committing crimes and therefore reduces crime rates. Their radical conclusion follows an economic model of rational deterrence which states that once the cost of committing an offense outweighs the benefits, the criminals are deterred, assuming that “there is no difference between criminal and noncriminals, other than their assessment of the costs and benefits of committing crimes”$$^{11}$$.

The authors’ methodology for investigating the relationship between shall-issue laws and crime rates employs twoway fixed effects regressions which can suffer from substantial bias in the case of dynamic treatment effects and staggered treatment adoption. We reexamine the association using estimators that are robust to differential timing such as those invented by Callaway and Sant’Anna and Sun and Abraham. We find that concealed-weapons laws have negative effects only on a subset of all crime rates. In particular, we find that the laws only help reduce violent crime rates, aggravated assault rates, murder rates, and burglary rates. For other crimes, results show positive effects. In any case, the Lott and Mustard analysis serves as a starting point that calls for further analysis on this topic. This sort of analysis, coupled with modern statistical techniques, enable legislators and policymakers to devise appropriate policies to achieve safety and security of the nation.

#### 7.2 Things I learned from this exercise

Lott and Mustard replication offers a valuable hands-on experience on how to implement contemporary statistical methods on the ongoing controversial debate on right-to-carry concealed weapons laws. I get to deal with the original data set and perform analyses to reexamine the findings of the original study. The assignment also leads me to do further research on related literature regarding this topic. The conversation around this topic is definitely contentious because many researchers pointed out flaws and possible specification errors in the original paper. Moody (2001) disagrees with the use of log-level regression, citing that it is unusual for a crime study. Instead, he proceeds with double-log model and finds smaller results than those suggested by Lott and Mustard. In addition, he pointed out the issue of omitted variables bias, namely, incarceration rate. Further, he suggested investigation of time-series aspects of the data$$^2$$. All in all, the assignment helps me familiarize myself with topics discussed among researchers, and allows me to apply statistical techniques to draw causal inference. 


### References
1. Lott, Jr., John&nbsp;R., and David&nbsp;B. Mustard. “Crime, Deterrence, and Right‐to‐Carry Concealed Handguns.” The Journal of Legal Studies 26, no. 1 (January 1997): 1–68. https://doi.org/10.1086/467988. 

2. Moody, Carlisle&nbsp;E. “Testing for the Effects of Concealed Weapons Laws: Specification Errors and Robustness.” The Journal of Law and Economics 44, no. S2 (October 2001): 799–813. https://doi.org/10.1086/323313.

3. Rauhut, Heiko. “Game Theory.” Oxford Handbooks Online, November 8, 2015. https://doi.org/10.1093/oxfordhb/9780199338801.013.7.

4. Ayres, Ian, and John Donohue. “Shooting down the More Guns, Less Crime Hypothesis,” November 2002. https://doi.org/10.3386/w9336. 

5. Moody, Carlisle E., and Thomas B. Marvell. “The Debate on Right-to-Carry Concealed Weapons Laws,” January 2008. 

6. Cunningham, Scott. Causal Inference: The Mixtape. New Haven, CT: Yale University Press, 2021. 

7. Huntington-Klein, Nick. The Effect: An Introduction to Research Design and Causality. Boca Raton, FL: CRC Press, 2022. 

8. Callaway, Brantly, and Pedro H.C. Sant’Anna. “Difference-in-Differences with Multiple Time Periods.” Journal of Econometrics 225, no. 2 (2021): 200–230. https://doi.org/10.1016/j.jeconom.2020.12.001. 

9. Sun, Liyang, and Sarah Abraham. “Estimating Dynamic Treatment Effects in Event Studies with Heterogeneous Treatment Effects.” Journal of Econometrics 225, no. 2 (2021): 175–99. https://doi.org/10.1016/j.jeconom.2020.09.006. 

10. “An Interview with John R. Lott, Jr. Author of More Guns, Less Crime: Understanding Crime and Gun Control Laws.” University of Chicago Press, 1998. University of Chicago Press. https://press.uchicago.edu/Misc/Chicago/493636.html. 

11. Minnesota House Research, and Ben Johnson, Do criminal laws deter crime?: Deterrence theory in criminal justice policy: A Primer § (2019). 